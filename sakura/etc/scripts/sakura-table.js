const tableData = {
    "Артик": {
        tours: 3,
        team: "ЗПГ",
        score: 83.75,
        img: "../etc/images/players/Artik.jpeg",
    },
    "Архи": {
        tours: 4,
        score: 119,
        team: "Под(д)ержим Ремчика!",
        img: "../etc/images/players/Arhi.jpeg",
    },
    "Интерактив": {
        tours: 3,
        score: 94.25,
        team: "Банда экстремистов",
        img: "../etc/images/players/Inter.jpeg",
    },
    "Сергеевна": {
        tours: 4,
        score: 106.75,
        team: "Ночная фурия",
        img: "../etc/images/players/Sergeevna.jpeg",
    },
    "Боня": {
        tours: 3,
        score: 73.75,
        team: "Не ангелы",
        img: "../etc/images/players/Bonya.jpeg",
    },
    "SOVEST": {
        tours: 4,
        score: 105.25,
        team: "Япона мать",
        img: "../etc/images/players/Sovest.jpeg",
    },
    "Жнец": {
        tours: 3,
        score: 89.25,
        team: "Город-герой и 2 героини",
        img: "../etc/images/players/Jnec.jpeg",
    },
    "Young": {
        tours: 4,
        score: 111.75,
        team: "С кем я мафия?!",
        img: "../etc/images/players/Young.jpeg",
    },
    "Юрия": {
        tours: 4,
        score: 106.5,
        team: "Понапикали!",
        img: "../etc/images/players/Yria.jpeg",
    },
    "Скарлетт": {
        tours: 4,
        score: 108.25,
        team: "Город-герой и 2 героини",
        img: "../etc/images/players/Skarlet.jpeg",
    },
    "Пчела": {
        tours: 4,
        score: 105.5,
        team: "Ну мёд, медятина!",
        img: "../etc/images/players/Pcela.jpeg",
    },
    "Мориарти": {
        tours: 3,
        score: 77.5,
        team: "Понапикали!",
        img: "../etc/images/players/Moriarti.jpeg",
    },
    "Саранча": {
        tours: 4,
        team: "ЗПГ",
        score: 96.5,
        img: "../etc/images/players/Sarancha.jpeg",
    },
    "Весна": {
        tours: 3, 
        score: 77.5,
        team: "Город-герой и 2 героини",
        img: "../etc/images/players/Vesna.jpeg",
    },
    "Michael": {
        tours: 3,
        score: 69,
        team: "Банда экстремистов",
        img: "../etc/images/players/Michael.jpeg",
    },
    "Gadfour": {
        tours: 3,
        score: 75,
        team: "Под(д)ержим Ремчика!",
        img: "../etc/images/players/Gadfour.jpeg",
    },
    "Лекса": {
        tours: 3,
        score: 70.5,
        team: "Япона мать",
        img: "../etc/images/players/Leksa.jpeg",
    },
    "Lina": {
        tours: 4,
        score: 93.5,
        team: "Банда экстремистов",
        img: "../etc/images/players/Lina.jpeg",
    },
    "Morti": {
        tours: 3,
        score: 49.5,
        team: "Не ангелы",
        img: "../etc/images/players/Morti.jpeg",
    },
    "Злая Киса": {
        tours: 3,
        score: 77.50,
        team: "С кем я мафия?!",
        img: "../etc/images/players/ZK.jpeg",
    },
    "Марго": {
        tours: 3,
        score: 82.25,
        team: "Не ангелы",
        img: "../etc/images/players/Margo.jpeg",
    },
    "Спонжик": {
        tours: 3,
        score: 79,
        team: "Понапикали!",
        img: "../etc/images/players/Sponjik.jpeg",
    },
    "Бестия": {
        tours: 3,
        score: 79.5,
        team: "Ночная фурия",
        img: "../etc/images/players/Bestia.jpeg",
    },
    "Cherry Pick": {
        tours: 3,
        score: 83.25,
        team: "С кем я мафия?!",
        img: "../etc/images/players/Cherry.png",
    },
    "Грибочки": {
        tours: 3,
        score: 68.5,
        team: "Ночная фурия",
        img: "../etc/images/players/Gribochki.jpeg",
    },
    "Rocket Woman": {
        tours: 3,
        team: "ЗПГ",
        score: 71.25,
        img: "../etc/images/players/Roket.jpeg",
    },
    "Джейн": {
        tours: 3,
        score: 79.75,
        team: "Под(д)ержим Ремчика!",
        img: "../etc/images/players/Jane.jpeg",
    },
    "Curly": {
        tours: 3,
        score: 77.5,
        team: "Япона мать",
        img: "../etc/images/players/Curly.jpeg",
    },
    "Манекен": {
        tours: 3,
        score: 84.25,
        team: "Ну мёд, медятина!",
        img: "../etc/images/players/Maneken.jpeg",
    },
    "Карась": {
        nickname: "Карась",
        tours: 3,
        score: 70,
        team: "Ну мёд, медятина!",
        img: "../etc/images/players/Karas.jpeg",
    },
};

const teamDate = {
    "teams": [
        {
            "teamName": "Ну мёд, медятина!",
            "teamates": "Пчела, Манекен, Карась",
            "games": [
                28, 22, 26.25, 27.5, 27, 29, 20.5, 27, 24.25, 28.25,
            ],
        },
        {
            "teamName": "Понапикали!",
            "teamates": "Юрия, Мориарти, Спонжик",
            "games": [
                22.25, 19.25, 28, 30.25, 35, 32.75, 24.5, 24.5, 21.75, 24.75,
            ],
        },
        {
            "teamName": "Япона Мать",
            "teamates": "SOVEST, Лекса, Curly",
            "games": [
                26, 23.5, 20.75, 27, 27, 29.75, 21, 25.75, 23.75, 28.75,
            ],
        },
        {
            "teamName": "Город-герой и 2 героини",
            "teamates": "Жнец, Скарлетт, Весна",
            "games": [
                25.5, 25.25, 32.5, 28.75, 27.25, 29.25, 28.75, 21.5, 28.75, 27.5,
            ],
        },
        {
            "teamName": "Не Ангелы",
            "teamates": "Боня, Марго, Morti",
            "games": [
                26.5, 28.75, 30, 19.5, 23.5, 18, 15.5, 16, 27.75, 16.75,
            ],
        },
        {
            "teamName": "С кем я мафия?!",
            "teamates": "Young, Злая Киса, Cherry Pick",
            "games": [
                21, 24.75, 27.75, 26.75, 25.75, 30.75, 22, 29.75, 37.25, 26.75,
            ],
        },
        {
            "teamName": "Под(д)ержим Ремчика!",
            "teamates": "Архи, Gadfour, Джейн",
            "games": [
                27.25, 27.25, 31, 27.75, 20.75, 31.25, 20, 22.75, 31.75, 34,
            ],
        },
        {
            "teamName": "Ночная Фурия",
            "teamates": "Сергеевна, Бестия, Грибочки",
            "games": [
                32.5, 20.5, 26.5, 24.75, 24.5, 21.25, 25.75, 23.75, 23, 32,
            ],
        },
        {
            "teamName": "Закрытая покемонная группировка",
            "teamates": "Артик, Саранча, Rocket Woman",
            "games": [
            19.5, 33.5, 26, 24.75, 31.25, 25.25, 20, 19, 33.5, 18.75,
            ],
        },
        {
            "teamName": "Банда экстремистов",
            "teamates": "Интерактив, Michael, Lina",
            "games": [
                23, 24, 24.5, 22.25, 34, 30.75, 29.5, 27.5, 22, 19.25,
            ],
        },
    ],
};

const data = {
    "Архи": [
        "Архи", "Gadfour", "Грибочки", "Джейн",
    ],
    "Флэш": [
        "Интерактив", "Весна", "Бестия", "Карась",
    ],
    "Марко Ройс": [
        "Интерактив", "Злая Киса", "Rocket Woman", "Марго",
    ],
    "SCHOKK": [
        "Интерактив", "Саранча", "Злая Киса", "Манекен",
    ],
    "Карась": [
        "Артик", "Боня", "Манекен", "Карась",
    ],
    "ППК": [
        "Интерактив", "Morti", "Gadfour", "Манекен",
    ],
    "Morti": [
        "Архи", "Morti", "Rocket Woman", "Карась",
    ],
    "Есаул": [
        "Артик", "Gadfour", "Злая Киса", "Джейн",
    ],
    "Марго": [
        "Боня", "Пчела", "Марго", "Джейн",
    ],
    "Лекса": [
        "SOVEST", "Лекса", "Злая Киса", "Спонжик",
    ],
    "Скарлетт": [
        "Интерактив", "Скарлетт", "Джейн", "Манекен",
    ],
    "Пчела": [
        "Интерактив", "Пчела", "Cherry Pick", "Манекен",
    ],
    "Бендер": [
        "Интерактив", "Саранча", "Марго", "Манекен",
    ],
    "Юрия": [
        "Юрия", "Мориарти", "Спонжик", "Марго",
    ],
    "SOVEST": [
        "SOVEST", "Лекса", "Злая Киса", "Бестия",
    ],
    "Сергеевна": [
        "Сергеевна", "Бестия", "Грибочки", "Карась",
    ],
    "Манекен": [
        "Интерактив", "Бестия", "Грибочки", "Манекен",
    ],
    "Весна": [
        "Артик", "Весна", "Бестия", "Манекен",
    ],
    "Джейн": [
        "SOVEST", "Пчела", "Rocket Woman", "Джейн",
    ],
    "Бестия": [
        "Сергеевна", "Саранча", "Бестия", "Манекен",
    ],
    "Michael": [
        "Интерактив", "Michael", "Джейн", "Манекен",
    ],
    "Rocket Woman": [
        "Артик", "Саранча", "Джейн", "Rocket Woman",
    ],
    "Cherry Pick": [
        "Интерактив", "Morti", "Cherry Pick", "Rocket Woman",
    ],
    "Lina": [
        "Интерактив", "Lina", "Спонжик", "Манекен",
    ],
    "Young": [
        "Young", "Пчела", "Злая Киса", "Cherry Pick",
    ],
    "Лексус": [
        "Боня", "Morti", "Злая Киса", "Бестия",
    ],
    "Yuliya": [
        "Интерактив", "Morti", "Лекса", "Манекен",
    ],
    "Curly": [
        "Сергеевна", "Пчела", "Curly", "Джейн",
    ],
    "Грибочки": [
        "Сергеевна", "Скарлетт", "Грибочки", "Манекен",
    ],
    "Спонжик": [
        "Интерактив", "Gadfour", "Спонжик", "Джейн",
    ],
    "Артик": [
        "Артик", "Саранча", "Бестия", "Карась",
    ],
    "Злая Киса": [
        "Интерактив", "Злая Киса", "Бестия", "Манекен",
    ],
    "Мориарти": [
        "Юрия", "Мориарти", "Спонжик", "Злая Киса",
    ],
    "Самаритянка": [
        "Интерактив", "Мориарти", "Бестия", "Карась",
    ],
    "Паника": [
        "Интерактив", "Gadfour", "Марго", "Джейн",
    ],
    "Саранча": [
        "Артик", "Саранча", "Rocket Woman", "Манекен",
    ],
    "Панда из Руанды": [
        "Юрия", "Марго", "Грибочки", "Манекен",
    ],
    "Ася": [
        "Young", "Мориарти", "Марго", "Rocket Woman",
    ],
    "Виктор": [
        "Сергеевна", "Саранча", "Rocket Woman", "Cherry Pick",
    ],
    "Гурнік": [
        "Юрия", "Скарлетт", "Бестия", "Джейн",
    ],
    "Жнец": [
        "Артик", "Жнец", "Манекен", "Карась",
    ],
    "Gadfour": [
        "Архи", "Gadfour", "Lina", "Карась",
    ],
    "Teslex": [
        "Пчела", "Весна", "Rocket Woman", "Джейн",
    ],
    "Remedy": [
        "Сергеевна", "Пчела", "Злая Киса", "Манекен",
    ],
    "Ад": [
        "Жнец", "Michael", "Lina", "Curly",
    ],
    "Slam": [
        "SOVEST", "Саранча", "Lina", "Джейн",
    ],
    "Лили": [
        "Интерактив", "Lina", "Бестия", "Джейн",
    ],
    "Мишок": [
        "Артик", "Весна", "Спонжик", "Карась",
    ],
    "Боня": [
        "Боня", "Morti", "Марго", "Бестия",
    ],
    "Интерактив": [
        "Интерактив", "Gadfour", "Марго", "Манекен",
    ],
    "Yesterday": [
        "Интерактив", "Michael", "Rocket Woman", "Манекен",
    ],
};

let fanTable = [];

let activeFantasyTeamate;

$(document).ready(function() {
    applyTeamTable();
    applySoloTable();
    buildFantasyTable();

    const hashtag = window.location.hash.substring(1);
    
    switch(hashtag) {
        case "teams-table":
            showTable(".main-table", "#teams");
            break;
        case "solo-table":
            showTable(".solo-table", "#solo");
            break;
        case "fantasy-table":
            showTable(".fantasy-table", "#fantasy");
            break;
        case "games-table":
            showTable(".games-table", "#games");
            break;
        default:
            showTable(".main-table", "#teams");
            break;
    };


    $('#teams').click(function() {
        $('.solo-table').hide();
        $('.fantasy-table').hide();
        $('.games-table').hide();
        $('.main-table').show();
        $('#teams').css("color", "lightpink");
        $('#solo').css("color", "aliceblue");
        $('#fantasy').css("color", "aliceblue");
        $('#games').css("color", "aliceblue");
    });

    $('#solo').click(function() {
        $('.main-table').hide();
        $('.fantasy-table').hide();
        $('.games-table').hide();
        $('.solo-table').show();
        $('#solo').css("color", "lightpink");
        $('#teams').css("color", "aliceblue");
        $('#fantasy').css("color", "aliceblue");
        $('#games').css("color", "aliceblue");
    });

    $('#fantasy').click(function() {
        $('.main-table').hide();
        $('.solo-table').hide();
        $('.games-table').hide();
        $('.fantasy-table').show();
        $('#solo').css("color", "aliceblue");
        $('#teams').css("color", "aliceblue");
        $('#games').css("color", "aliceblue");
        $('#fantasy').css("color", "lightpink");
    });

    $('#games').click(function() {
        $('.main-table').hide();
        $('.solo-table').hide();
        $('.games-table').show();
        $('.fantasy-table').hide();
        $('#solo').css("color", "aliceblue");
        $('#teams').css("color", "aliceblue");
        $('#games').css("color", "lightpink");
        $('#fantasy').css("color", "aliceblue");
    });
});

function showTable(tableClass, tableHash) {
    $('.main-table').hide();
    $('.solo-table').hide();
    $('.fantasy-table').hide();
    $('.games-table').hide();
    $(tableClass).show();

    $('#teams').css("color", "aliceblue");
    $('#solo').css("color", "aliceblue");
    $('#fantasy').css("color", "aliceblue");
    $('#games').css("color", "aliceblue");
    $(tableHash).css("color", "lightpink");
}

function applyTeamTable() {
    let table = "<table>";
    table += "<tr><th>#</th><th>Команда</th><th>Серия 1</th><th>Серия 2</th><th>Серия 3</th><th>Серия 4</th><th>Серия 5</th>" + 
             "<th>Серия 6</th><th>Серия 7</th><th>Серия 8</th><th>Серия 9</th><th>Серия 10</th><th>Итог</th></tr>";

    teamDate.teams.sort((a, b) => {
        let total1 = 0;
        let total2 = 0;

        a.games.forEach((gameScore) => {
            total1 += gameScore;
        });
        b.games.forEach((gameScore) => {
            total2 += gameScore;
        });

        if (total1 < total2) {
            return 1;
        }
        if (total1 > total2) {
            return -1;
        }
        return 0;
    });

    teamDate.teams.forEach((team, index) => {
        let total = 0;
        let games = 0;
        table += "<tr><td>" + (index + 1) + "</td><td>" + team.teamName + "<p class='teamates'>" + team.teamates + "</p></td>";
        team.games.forEach((gameScore) => {
            table += gameScore !== 0 ? "<td class='cell-score'>" + gameScore + "</td>" : "<td></td>";
            games += gameScore !== 0 ? 1 : 0;
            total += gameScore;
        });
        table += "<td class='total-score'>" + total + "</td></tr>";
    });

    table += "</table>"
    $('.main-table').append(table);
}


function applySoloTable() {
    let soloTable = "<table>";
    soloTable += "<tr><th>#</th><th>Игрок</th><th>Итог (Ср. зн.)</th></tr>";
    

    let playerNamesArray = Object.keys(tableData).sort((a, b) => {
        let var1 = tableData[a].tours !== 0 ? (tableData[a].score / tableData[a].tours) : 0;
        let var2 = tableData[b].tours !== 0 ? (tableData[b].score / tableData[b].tours) : 0;

        if (var1 < var2) {
        return 1;
        }
        if (var1 > var2) {
        return -1;
        }
        return 0;
    });

    playerNamesArray.forEach((playerName, index) => {
        soloTable += "<tr><td>" + (index + 1) + "</td><td class='solo-player'><div class='solo-player-img' style='background-image: url(" + 
                      tableData[playerName].img  + ")'></div><div class='solo-player-wrapper'><p class='player-name'>" + playerName + "</p><p class='team-name'>" + tableData[playerName].team + "</p></div></td>";

        const tours = tableData[playerName].tours;
        const avg = tours !== 0 ? (tableData[playerName].score / tours) : 0;
        soloTable += "<td class='avg-score'>" + Math.round(avg * 1000) / 1000 + " <span>(" + tours + ")</span></td></tr>"
    });

    soloTable += "</table>"
    $('.solo-table').append(soloTable);
}

function buildFantasyTable() {
    Object.keys(data).forEach((fpsPlayerName) => {
        let playerObject = { "playerName" : fpsPlayerName, "team": [], };
        let totalScore = 0;
        let totalPlayers = 0;
        data[fpsPlayerName].forEach(player => {
            const playerScore = tableData[player].score;
            const playerTours = tableData[player].tours;
            let avgScore;
            if (playerTours !== 0) {
                avgScore = playerScore / playerTours;
                totalPlayers++;
            } else {
                avgScore = 0;
            }
            const playerImg = tableData[player].img;
            playerObject.team.push( {player, "playerImg": playerImg, "playerScore": Math.round(avgScore * 1000) / 1000} );
            totalScore += avgScore;
        });

        playerObject.totalScore = Math.round(totalScore * 1000) / 1000;
        if (totalPlayers !== 0) {
            let avg = Math.round((totalScore / totalPlayers) * 1000) / 1000;
            playerObject.averageScore = avg;
        } else {
            playerObject.averageScore = 0;
        }
        fanTable.push(playerObject);
    });

    sortFantasy("totalScore");
}

function sortFantasy(param) {
    fanTable.sort((a, b) => {
        if (a[param] < b[param]) {
            return 1;
        }
        if (a[param] > b[param]) {
            return -1;
        }
        return 0;
    });

    fanTable.forEach((row, index) => {
        row.number = index + 1;
    });

    buildTable(fanTable);
}

function buildTable(table) {
    $('.fantasy-table').empty();
    let t = "<table><tr><th>#</th><th>Игрок</th><th colspan='4'>Команда</th><th id='total'>Итог</th><th id='average'>Ср. зн.</th></tr>";
    table.forEach(row => {
        const rofl = row.number === 1 ? "<p class='rofl'>Show me the money</p>" : "";
        t += "<tr><td>" + row.number + "</td><td class='player-name'>" + row.playerName + rofl + "</td>";
        row.team.forEach(team => {
            const selectedUserClass = team.player === activeFantasyTeamate ? "selected" : "";
            t += "<td><div name='" + team.player + "'class='fantasy-table-player-img " + selectedUserClass + "' style='background-image: url(" + team.playerImg + ")'></div>" 
                    + "<p class='fanstsy-score'>" + team.playerScore + "</p></td>";
        });
        t += "<td class='score'>" + row.totalScore + "</td>";
        t += "<td class='score'>" + row.averageScore + "</td>";
        t += "</tr>";
    });


    t += "</table>";
    $('.fantasy-table').append(t);

    $('#total').click(function() {
        sortFantasy("totalScore");
    });

    $('#average').click(function() {
        sortFantasy("averageScore");
    });

    $('.fantasy-table-player-img').click(function(event) {
        const playerName = $(event.target).attr('name');
        if (activeFantasyTeamate === playerName) {
            activeFantasyTeamate = "";
            buildTable(fanTable);
        } else {
            activeFantasyTeamate = playerName;
            let sortedFanTable = [];
            fanTable.forEach((row, index) => {
                row.team.forEach(teamate => {
                    if (teamate.player === playerName) {
                        sortedFanTable.push(row);
                    }
                });
            });

            buildTable(sortedFanTable);
        }
    });
}